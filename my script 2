-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local lp = Players.LocalPlayer
local mouse = lp:GetMouse()
local chr = lp.Character or lp.CharacterAdded:Wait()
local hum = chr:WaitForChild("Humanoid")

-- Flags
local skyEnabled = false
local aimbotEnabled = false
local isRunning = true
local lockedTarget = nil

-- UI Setup (unchanged from previous version)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "BIGNICKOZZZ_GUI"
screenGui.ResetOnSpawn = false
screenGui.Enabled = true
screenGui.Parent = lp:WaitForChild("PlayerGui")

local uiCorner = Instance.new("UICorner")
local function createButton(text)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -20, 0, 40)
    btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 16
    btn.Text = text
    uiCorner:Clone().Parent = btn
    return btn
end

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 260, 0, 220)
mainFrame.Position = UDim2.new(0.5, -130, 0.5, -110)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.Active = true
mainFrame.Draggable = true
uiCorner.Parent = mainFrame
mainFrame.Parent = screenGui

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 40)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 80, 255)
title.Text = "BIGNICKOZZZ SCRIPT"
title.Font = Enum.Font.GothamBlack
title.TextSize = 20
title.Parent = mainFrame

local skyButton = createButton("Sky: Disabled")
skyButton.Position = UDim2.new(0, 10, 0, 50)
skyButton.Parent = mainFrame

local aimbotButton = createButton("Aimbot: Disabled")
aimbotButton.Position = UDim2.new(0, 10, 0, 100)
aimbotButton.Parent = mainFrame

local closeButton = createButton("Close")
closeButton.Position = UDim2.new(0, 10, 0, 150)
closeButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
closeButton.Parent = mainFrame

-- Button Logic
skyButton.MouseButton1Click:Connect(function()
    skyEnabled = not skyEnabled
    skyButton.Text = skyEnabled and "Sky: Enabled" or "Sky: Disabled"
end)

aimbotButton.MouseButton1Click:Connect(function()
    aimbotEnabled = not aimbotEnabled
    aimbotButton.Text = aimbotEnabled and "Aimbot: Enabled" or "Aimbot: Disabled"
end)

closeButton.MouseButton1Click:Connect(function()
    isRunning = false
    screenGui:Destroy()
end)

-- Aimbot Logic
local function getClosestPlayer()
    local closest, distance = nil, math.huge
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= lp and plr.Character and plr.Character:FindFirstChild("Head") then
            local head = plr.Character.Head
            local screenPoint, onScreen = Workspace.CurrentCamera:WorldToViewportPoint(head.Position)
            if onScreen then
                local dist = (Vector2.new(mouse.X, mouse.Y) - Vector2.new(screenPoint.X, screenPoint.Y)).Magnitude
                if dist < distance and dist < 150 then
                    closest = head
                    distance = dist
                end
            end
        end
    end
    return closest
end

-- ESP Logic (only active when aimbot is locked)
local function createESP(player)
    -- Create the purple ESP marker
    local espPart = Instance.new("Part")
    espPart.Size = Vector3.new(2, 2, 2)  -- Size slightly larger than the head
    espPart.Shape = Enum.PartType.Ball
    espPart.Anchored = true
    espPart.CanCollide = false
    espPart.Material = Enum.Material.Neon
    espPart.BrickColor = BrickColor.new("Royal purple")  -- Purple color
    espPart.Transparency = 0.5  -- Semi-transparent
    espPart.Name = "ESPPart"
    espPart.Parent = player.Character
    
    -- Update position to follow the player's head or humanoid root part
    game:GetService("RunService").RenderStepped:Connect(function()
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = player.Character:FindFirstChild("HumanoidRootPart")
            espPart.Position = hrp.Position + Vector3.new(0, 5, 0)  -- Slightly above the character
        end
    end)

    return espPart  -- Return the ESP part for later removal
end

local function removeESP(espPart)
    if espPart then
        espPart:Destroy()  -- Remove the ESP part when it's no longer needed
    end
end

-- Aimbot Logic for Locking Target
UserInputService.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 and aimbotEnabled then
        lockedTarget = getClosestPlayer()
        if lockedTarget then
            -- If a player is locked, create the ESP highlight
            local espPart = createESP(lockedTarget.Parent)  -- Create ESP on the locked target
            lockedTarget.Parent:SetAttribute("ESPPart", espPart)  -- Store the ESP part for later removal
        end
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        lockedTarget = nil
        -- Remove the ESP when unlocking the target
        if lockedTarget and lockedTarget.Parent and lockedTarget.Parent:GetAttribute("ESPPart") then
            removeESP(lockedTarget.Parent:GetAttribute("ESPPart"))
            lockedTarget.Parent:SetAttribute("ESPPart", nil)
        end
    end
end)

RunService.RenderStepped:Connect(function()
    if lockedTarget then
        local cam = Workspace.CurrentCamera
        local targetPos = lockedTarget.Position + Vector3.new(0, 0.1, 0)
        cam.CFrame = CFrame.new(cam.CFrame.Position, targetPos)
    end
end)

-- Clean up ESP when the character resets
lp.CharacterAdded:Connect(function(newChar)
    chr = newChar
    hum = chr:WaitForChild("Humanoid")
    -- Remove any existing ESP part when the character is reset
    if chr:GetAttribute("ESPPart") then
        removeESP(chr:GetAttribute("ESPPart"))
    end
end)
